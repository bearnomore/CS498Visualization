<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>D3: Loading GeoJSON data and generating SVG paths</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <style type="text/css">
	  h1 {
           color: black;
           font-size: 20px;
         }
      p  {
           color: black;
           font-size: 16px;
		   txt-align: left;
         }
    </style>
  </head>
  <body>
    <h1> The Youth of the Countries </h1>
	<p> Countries are made by humans and their physical ages, instead of the historical ages, can be represented by the median age of their own populations.<br>
	    Check out how old the countries are around the world by hovering your mouse on the map. </p>
	
    <div id="viz1"> </div>
	<div id="viz2"> </div>
    <script type="text/javascript">
      //Width and height
      var w = 800;
      var h = 600;

      var margin = {
          top: 50,
          bottom: 50,
          left: 20,
          right: 20
        };

        var width = w - margin.left - margin.right;
        var height = h - margin.top - margin.bottom;

      
      // define map projection
      var projection = d3.geoMercator()
        .translate([w/2, h/2])
		.center([0,20])
        .scale([140]);

      //Define default path generator
      var path = d3.geoPath()
                   .projection(projection);

      var svg = d3.select("#viz1")
                  .append("svg")
                  .attr("id", "chart")
                  .attr("width", w)
                  .attr("height", h)
                  .append("g")
                  .attr("tranform", "translate(0" + margin.left + "," + margin.top + ")");

      

      d3.csv("https://raw.githubusercontent.com/bearnomore/CS498Visualization/master/world_profile20.csv", function(data){

		 var colorScale = d3.scaleThreshold()
                            .domain([20, 30, 35, 40, 45])
                            .range(["#adebad", "#70db70", "#33cc33", "#248f24", "#145214", "#0a290a" ]);

      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function(json){

        //Merge the agriculture and GeoJSON data
        //Loop through once for each agriculture data value
        for(var i = 0; i < data.length; i++){
          // grab state name
          var dataCode = data[i].Code;

          //grab data value, and convert from string to float
          var dataAge = parseFloat(data[i].MedianAge);

          //find the corresponding state inside the GeoJSON
          for(var n = 0; n < json.features.length; n++){

            // properties name gets the states name
            var jsonCode = json.features[n].id;
            // if statment to merge by name of state
            if(dataCode == jsonCode){
              //Copy the data value into the JSON
              // basically creating a new value column in JSON data
              json.features[n].properties.medianAge = dataAge;

              //stop looking through the JSON
              break;
            }
          }
        }
		
        // Make a tooltip
		var tooltip = d3.select("#viz1")
                        .append("div")
                        .style("opacity", 0)
                        .attr("class", "tooltip")
                        .style("background-color", "white")
                        .style("border", "black")
                        .style("border-width", "1px")
                        .style("border-radius", "5px")
                        .style("padding", "5px")
						.style("font-size", "16px");
	
        // A function that change this tooltip when the user hover a point.
        // Its opacity is set to 1: we can now see it. Plus it set the text and position of tooltip depending on the datapoint (d)
        var mouseover = function(d) {
		                              var value = d.properties.medianAge;
		                              tooltip.style("opacity", 1);
		                              d3.select(this).style("fill", "yellow");
									 }

        var mousemove = function(d) {
		                             var value = d.properties.medianAge;
									 var country = d.properties.name;
                                     tooltip.html("Median Age of " + country + ":"+value)
                                            .style("left", (d3.mouse(this)[0]+90) + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
                                            .style("top", (d3.mouse(this)[1]) + "px")
                                    }

        // A function that change this tooltip when the leaves a point: just need to set opacity to 0 again
        var mouseleave = function(d) {
                                      tooltip.transition()
                                             .duration(200)
                                             .style("opacity", 0);
								      var value = d.properties.medianAge;
		                              d3.select(this).style("fill", value? colorScale(value):"#ccc");
                                     }
		
		
        svg.selectAll("path")
          .data(json.features)
          .enter()
          .append("path")
          .attr("d", path)
		  .style("stroke", "black")
          .style("fill", function(d){
            //get the data value
            var value = d.properties.medianAge;

            if(value){
              //If value exists
              return colorScale(value);
            } else {
              // If value is undefined
              //we do this because alaska and hawaii are not in dataset we are using but still in projections
              return "#ccc"
            }

          })
		  .on("mouseover", mouseover )
          .on("mousemove", mousemove )
          .on("mouseleave", mouseleave );
		  
		  /*
		  .on("mouseover", function(d){d3.select(this).style("fill", "yellow");})
		  .on("mouseout", function(d){
		                  var value = d.properties.medianAge;
		                  d3.select(this).style("fill", value? colorScale(value):"#ccc");
		                  })*/
      });
	  
	  // Add legend
	  //create a new SVG in the body
	  var legend = d3.legendColor().scale(colorScale);
	  svg.append("g")
         .attr("transform", "translate(20,400)")
         .call(legend);
	/*
      const legend = d3.select("#viz1").append('svg')
                       .attr('class', 'legend') //add it with the '.legend' class
                       .attr('width', 148) //it should be 14px wide
                       .attr('height', 148) //and 148px high
					   .selectAll('g') //then either select all the 'g's inside the svg or create placeholders
    //Fill the data into our placeholders in reverse order
    //This arranges our legend in descending order.
    //The 'data' here is the items we entered in the 'domain',
    //in this case [min, max]
    //We use 'slice()' to create a shallow copy of the array
    //Since we don't want to modify the original one
                       .data(colorScale.domain().slice())
    //Every node in teh data should have a 'g' appended
                       .enter().append('g')
    //the 'g' should have this attribute
                       .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
    //Inside every 'legend', insert a rect
      legend.append("rect")
            .attr("width", 18)//that's 18px wide
            .attr("height", 18)//and 18px high
            .style("fill", colorScale);//then fill it will the color assigned by the scale
      legend.append("text")
            .attr("x", 50)
            .attr("y", -100)
            .attr("dy", ".35em")
            .text(function(d) {return +d});
			
    */

})

    </script>
  </body>
</html>