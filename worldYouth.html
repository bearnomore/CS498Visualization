<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>D3: Loading GeoJSON data and generating SVG paths</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <style type="text/css">
	  h1 {
           color: black;
           font-size: 20px;
         }
	  p {
	       color: black;
		   font-size: 14px;
		   align-txt: left;
	  }

    </style>
  </head>
  <body>
    <h1> The Age of the Countries </h1>
	<p style=("font-family:courior; font-size:12px; color:black;"> Countries are made by humans and their physical ages, instead of the historical ages, can be represented by the median age of their own populations.<br>
	    Check out how old the countries are around the world by hovering your mouse on the map. What region in general has younger population than others?</p>
	
    <div id="viz1"> </div>
	<br>
    <script type="text/javascript">
	//For first plot
      //Width and height
      var w = 800;
      var h = 600;

      var margin = {
          top: 50,
          bottom: 50,
          left: 20,
          right: 20
        };

        var width = w - margin.left - margin.right;
        var height = h - margin.top - margin.bottom;

      
      // define map projection
      var projection = d3.geoMercator()
        .translate([w/2, h/2])
		.center([0,20])
        .scale([140]);

      //Define default path generator
      var path = d3.geoPath()
                   .projection(projection);

      var svg1 = d3.select("#viz1")
                  .append("svg")
                  .attr("id", "chart")
                  .attr("width", w)
                  .attr("height", h)
                  .append("g")
                  .attr("tranform", "translate(0" + margin.left + "," + margin.top + ")");

      

      d3.csv("https://raw.githubusercontent.com/bearnomore/CS498Visualization/master/world_profile20.csv", function(data){

		 var colorScale = d3.scaleThreshold()
                            .domain([20, 30, 35, 40, 45])
                            .range(["#adebad", "#70db70", "#33cc33", "#248f24", "#145214", "#0a290a" ]);

      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function(json){

        //Merge the agriculture and GeoJSON data
        //Loop through once for each agriculture data value
        for(var i = 0; i < data.length; i++){
          // grab state name
          var dataCode = data[i].Code;

          //grab data value, and convert from string to float
          var dataAge = parseFloat(data[i].MedianAge);

          //find the corresponding state inside the GeoJSON
          for(var n = 0; n < json.features.length; n++){

            // properties name gets the states name
            var jsonCode = json.features[n].id;
            // if statment to merge by name of state
            if(dataCode == jsonCode){
              //Copy the data value into the JSON
              // basically creating a new value column in JSON data
              json.features[n].properties.medianAge = dataAge;

              //stop looking through the JSON
              break;
            }
          }
        }
		
        // Make a tooltip
		var tooltip = d3.select("#viz1")
                        .append("div")
                        .style("opacity", 0)
                        .attr("class", "tooltip")
                        .style("background-color", "white")
                        .style("border", "black")
                        .style("border-width", "1px")
                        .style("border-radius", "5px")
                        .style("padding", "5px")
						.style("font-size", "16px");
	
        // A function that change this tooltip when the user hover a point.
        // Its opacity is set to 1: we can now see it. Plus it set the text and position of tooltip depending on the datapoint (d)
        var mouseover = function(d) {
		                              var value = d.properties.medianAge;
		                              tooltip.style("opacity", 1);
		                              d3.select(this).style("fill", "yellow");
									 }

        var mousemove = function(d) {
		                             var value = d.properties.medianAge;
									 var country = d.properties.name;
                                     tooltip.html("Median Age of " + country + ":"+value)
                                            .style("left", (d3.mouse(this)[0]+90) + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
                                            .style("top", (d3.mouse(this)[1]) + "px")
                                    }

        // A function that change this tooltip when the leaves a point: just need to set opacity to 0 again
        var mouseleave = function(d) {
                                      tooltip.transition()
                                             .duration(200)
                                             .style("opacity", 0);
								      var value = d.properties.medianAge;
		                              d3.select(this).style("fill", value? colorScale(value):"#ccc");
                                     }
		
		
        svg1.selectAll("path")
          .data(json.features)
          .enter()
          .append("path")
          .attr("d", path)
		  .style("stroke", "black")
          .style("fill", function(d){
            //get the data value
            var value = d.properties.medianAge;

            if(value){
              //If value exists
              return colorScale(value);
            } else {
              // If value is undefined
              //we do this because alaska and hawaii are not in dataset we are using but still in projections
              return "#ccc"
            }

          })
		  .on("mouseover", mouseover )
          .on("mousemove", mousemove )
          .on("mouseleave", mouseleave );
		  
      });
	  
	  // Add legend
	  //create a new SVG in the body
	  var legend = d3.legendColor().scale(colorScale);
	  svg1.append("g")
         .attr("transform", "translate(20,400)")
         .call(legend);
	
})
    </script>
	
    <h1> What affect the age structure of the countries </h1>
	<p> What factors determine the "Youth" of a country or the median age of its population? Perhaps how long its people are expected to live? 
	    Perhaps how many children its women give birth to on average? Check out the following scatter plot of Fertility Rate VS. Life expectancy 
		colored by region. Brush along X axis to zoom in and double click to go back to the original view. <br> <br> What is the relationship between these two 
		factors? And what region in general has high fertility rate and low life expectancy? </p>
	<div id="viz2"> </div>
	<script>
	// set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 50, left: 60},
        width = 600 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg2 = d3.select("#viz2")
                 .append("svg")
                 .attr("width", width + margin.left + margin.right)
                 .attr("height", height + margin.top + margin.bottom)
                 .append("g")
                 .attr("transform","translate(" + margin.left + "," + margin.top + ")");
		  
    //Read the data
    d3.csv("https://raw.githubusercontent.com/bearnomore/CS498Visualization/master/world_profile20.csv", function(data){
  
    // Add X axis
    var x = d3.scaleLinear()
              .domain([0, 10])
              .range([ 0, width ]);
    var xAxis = svg2.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

    // Add Y axis
    var y = d3.scaleLinear()
              .domain([40, 100])
              .range([ height, 0]);
	
    svg2.append("g")
        .call(d3.axisLeft(y));

    // Add X axis label:
    svg2.append("text")
        .attr("text-anchor", "end")
        .attr("x", width/2 + margin.left)
        .attr("y", height + margin.top + 25)
        .text("Fertility Rate");

    // Y axis label:
    svg2.append("text")
        .attr("text-anchor", "end")
        .attr("transform", "rotate(-90)")
        .attr("y", -margin.left + 20)
        .attr("x", -margin.top - height/2 + 60)
        .text("Life Expectancy (years)")	

    // Add a clipPath: everything out of this area won't be drawn.
    var clip = svg2.append("defs").append("svg:clipPath")
                   .attr("id", "clip")
                   .append("svg:rect")
                   .attr("width", width )
                   .attr("height", height )
                   .attr("x", 0)
                  .attr("y", 0);
	  
	  

    // Color scale: give me a nation name, I return a color
    var regions = ['Africa', 'Arab States', 'Asia & Pacific', 'Europe', 'Middle east', 'North America','South/Latin America'];
    var color = d3.scaleOrdinal()
                  .domain(regions)
                  .range([ "#FF0000","#FFFF00", "#151515","#3ADF00", "#2EFEF7", "#0000FF", "#CC2EFA"])
	
  
    // Add brushing
    var brush = d3.brushX()                 // Add the brush feature using the d3.brush function
                  .extent( [ [0,0], [width,height] ] ) // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
                  .on("end", updateChart) // Each time the brush selection changes, trigger the 'updateChart' function
  
    // Create the scatter variable: where both the circles and the brush take place
    var scatter = svg2.append('g')
                      .attr("clip-path", "url(#clip)");

    // Add circles
    scatter
      .selectAll("circle")
      .data(data)
      .enter()
      .append("circle")
      .attr("cx", function (d) { return x(d.FertRate); } )
      .attr("cy", function (d) { return y(d.LifeExpectancy); } )
      .attr("r", 8 )
      .style("fill", function (d) { return color(d.Region); } )
      .style("opacity", 0.5)
	  .style("stroke", "black")
    
    // Add the brushing
    scatter
      .append("g")
      .attr("class", "brush")
      .call(brush);
	
  
	  
    // A function that set idleTimeOut to null
    var idleTimeout
    function idled() { idleTimeout = null; }
  
    // A function that update the chart for given boundaries
    function updateChart() {
      extent = d3.event.selection;

    // If no selection, back to initial coordinate. Otherwise, update X axis domain
      if(!extent){
        if (!idleTimeout) return idleTimeout = setTimeout(idled, 350); // This allows to wait a little bit
        x.domain([0,10]);
	   
	   
      }else{
        x.domain([ x.invert(extent[0]), x.invert(extent[1]) ]);
	 
        scatter.select(".brush").call(brush.move, null); // This remove the grey brush area as soon as the selection has been done
      }
	
	// Update axis and circle position
      xAxis.transition().duration(1000).call(d3.axisBottom(x));
      scatter
        .selectAll("circle")
        .transition().duration(1000)
        .attr("cx", function (d) { return x(d.FertRate); } )
        .attr("cy", function (d) { return y(d.LifeExpectancy); } );
	  
	  svg2.append('g')
	      .selectAll("circle")
          .attr("cx", function (d) { return x(d.FertRate); } )
          .attr("cy", function (d) { return y(d.LifeExpectancy); } );
	   
    }
	
	// Add legend
	// Add one dot in the legend for each name.
	
    svg2.selectAll("mydots")
       .data(regions)
       .enter()
       .append("circle")
       .attr("cx", 400)
       .attr("cy", function(d,i){ return 27 + i*20}) // 100 is where the first dot appears. 25 is the distance between dots
       .attr("r", 3)
       .style("fill", function(d){ return color(d)})
	   .style("stroke", "black")
	   .style("opacity", 0.5);
	   
	// Add one dot in the legend for each name.
    svg2.selectAll("mylabels")
       .data(regions)
       .enter()
       .append("text")
       .attr("x", 410)
       .attr("y", function(d,i){ return 30 + i*20}) // 100 is where the first dot appears. 20 is the distance between dots
       .text(function(d){ return d})
       .attr("text-anchor", "left")
       .style("alignment-baseline", "bottom")
	   .style("font-size", "12px");
	   
	 
})
	</script>
  </body>
</html>